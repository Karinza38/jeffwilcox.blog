---
layout: post
comments: true
title: Getting Expression Encoder 2 SP1's media player template to work with CDNs
  and cross-domain embedding
wordpress_id: 154
wordpress_url: http://www.jeff.wilcox.name/2008/11/03/cross-domain-encoder-media-player/
imported_categories:
- title: c#
  slug: csharp
  autoslug: c#
- title: software-development
  slug: dev
  autoslug: software-development
- title: silverlight
  slug: silverlight
  autoslug: silverlight
- title: video
  slug: video
  autoslug: video
- title: microsoft
  slug: microsoft
  autoslug: microsoft
- title: web-development
  slug: webdev
  autoslug: web-development
imported_link_categories: []
tags: []
---
<p>The new Silverlight 2 media player that <a href="http://www.microsoft.com/expression/try-it/default.aspx?filter=servicepacks">Expression Encoder 2 SP1</a> ships with is great. You can encode video and output Silverlight content in minutes. With SP1, when you select one of the new templates, the only bits generated are your video asset + thumbnail, a single media player .Xap file, and a sample .Html page.</p> <p>This really cuts down on the moving parts from the previous 1.0 templates that had dependencies on so many loose JavaScript files.</p> <p>I wanted to blog about my experience in case others ran into this: if you have your Xap files on a domain different than your pages, you might find that the Silverlight plugin is blank and the media player never loads. This is a by-design feature per the Silverlight HTML DOM bridge security model - but you can actually do a few things to get this to work.</p> <p>I host my Silverlight applications and media assets on a separate domain. This creates the situation where the bridge is disabled; if you would like to reference the .Xap files from different sites or enable others to embed your video player, it won't work out of the box unless you modify the &lt;object /&gt; tag or modify and rebuild the managed media player to gracefully move on in this situation.</p> <p>Here's the breakdown that I have for my web pages vs. my Silverlight assets, including the apps:</p> <p><img src="http://media.jeff.wilcox.name/blog/view/CdnXap.png"/> </p> <p>The additional parameter within the object tag will be easiest for most folks, and is probably the way that the Expression team hopes that you'll enable this scenario. I always forget things like modifying the object tags, since this isn't in the default generated HTML file that Encoder outputs, so I'm going for a more involved solution.</p> <p>Oh, and don't get me wrong: SP1 rocks. I highly recommend that you install it; I'm getting so much more use out of Encoder 2 now. If you haven't purchased Encoder... well, you really should <a href="http://www.microsoft.com/expression/try-it/default.aspx">try</a> or <a href="http://www.microsoft.com/expression/products/Purchase.aspx?key=encoder">buy</a> it. With SP1 it not only adds the nice Silverlight 2 templates, but also H.264 mobile encoding. I was able encode my screencast in H.264, and it looks great on my iPhone!</p> <h3>The HTML DOM Bridge security model in Silverlight</h3> <p>Per the <a href="http://msdn.microsoft.com/en-us/library/cc645023(VS.95).aspx">DOM bridge security model</a> in Silverlight 2, the default behavior when the .Xap is hosted on a domain different than your web page, is that the HTML DOM bridge feature will be disabled for that Silverlight application in the .Xap. The DOM bridge is used by the managed media player to get the document URI property when trying to look up relative-path video assets.</p> <p>This situation can also present itself on the same domain, when the web page author explicitly denies the HTML DOM bridge access to a plugin: if the &lt;param name="EnableHtmlAccess" value="false" /&gt; tag is present in the object tag, the DOM bridge will not work and the media player template will end up throwing an exception while trying to access the HtmlPage.Document.DocumentUri property.</p> <h3>The quick fix</h3> <p>Inside your Silverlight plugin object tag, add the <strong>EnableHtmlAccess</strong> parameter with a value of 'true'. Here is a sample embedded object tag with the parameter added:</p> <blockquote> <p>&lt;object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="685" height="448"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp; &lt;param name="source" value="http://media.cdn.com/Xaps/MediaPlayerTemplate.xap" /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp; &lt;param name="initparams" value="expression encoder generated parameters go here" /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp; <font color="#ff0000"><strong>&lt;param name="enableHtmlAccess" value="true" /&gt;</strong></font><br />&lt;/object&gt;</p></blockquote> <h3>The source fix</h3> <p>I decided to just update the media player to not be dependent on the HTML DOM bridge feature.</p> <p>This fix assumes that you always provide the absolute URI for video assets in the playlist. Effectively it won't try any relative URI lookups when HTML DOM bridge access is not permitted. </p> <p>Thanks to the Expression team, they did a good thing and shipped the source to the media player template with the product. You will find it in <em>%programfiles%\Microsoft Expression\Encoder 2\Templates\en\SL2Standard\Source</em>. It opens with Visual Studio 2008 SP1 + the Silverlight 2 Developer Tools.</p> <p>I went ahead and rebuilt the template: whenever the C# code would try and use the HtmlPage.Document.DocumentUri getter, I would encase the code in an HtmlPage.IsEnabled check. I had to do this in just a few spots.</p> <p>One nice side effect was that I was able to chop the .Xap size down about 50K by removing the Adaptive Streaming support built into the template, since I just host my media assets over simple HTTP and do not do streaming.</p> <p>For your reference:</p> <p><strong><a href="http://media.jeff.wilcox.name/blog/code/ModifiedTemplate.zip">Download ModifiedTemplate.zip</a></strong> (69 K, solution in a Zip)<br /><strong><a href="http://www.jeff.wilcox.name/xap/2008/MediaPlayerTemplate.xap">Download MediaPlayerTemplate.xap</a></strong> (114 K, Xap)<br /><em>Note: Does not contain adaptive streaming support.</em></p> <h3>HtmlPage.IsEnabled lesson</h3> <p>You should always make sure to check the HtmlPage.IsEnabled property before attempting to access any of the HTML DOM bridge resources. This is good practice whether thinking about scenarios where the bridge is disabled, or designer tools like Cider and Blend.</p> <p><em>Disclaimer:</em> <em>I am not a member of the Expression team, this is not my area of expertise, other than being a member of the original HTML DOM bridge feature crew for Silverlight. I do not know if this was a known issue before, an expected, by-design feature, will be fixed, or anything like that.</em></p>

<h3>Live, embeddable player: Shawn Burke's PDC talk</h3>
<p>Oh, and here's Shawn Burke's excellent PDC talk. If you haven't checked out everything that was released in the Silverlight Toolkit, or heard about the release model, you should watch this. It is using my updated Xap player, so you can even embed Shawn's talk in your own blog.</p> <object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="685" height="448"><param name="source" value="http://media.jeff.wilcox.name/video/MediaPlayerTemplate.xap" /><param name="initparams" value="autoplay=False,autoload=False,enablecaptions=False,muted=False,stretchmode=0,displaytimecode=False,playlist=&lt;playList&gt;&lt;playListItems&gt;&lt;playListItem title=&quot;Shawn%20Burke%20-%20-Silverlight%20Toolkit%20talk%20at%20PDC%202008&quot; description=&quot;&quot; mediaSource=&quot;http://mschnlnine.vo.llnwd.net/d1/pdc08/WMV-HQ/PC35.wmv&quot; adaptiveStreaming=&quot;False&quot; thumbSource=&quot;http://media.jeff.wilcox.name/video/PC35_Thumb.jpg&quot; frameRate=&quot;30.00003000003&quot; width=&quot;984&quot; height=&quot;500&quot; &gt;&lt;/playListItem&gt;&lt;/playListItems&gt;&lt;/playList&gt;" />Your news reader may not permit Silverlight content. Please click-through to the original post to see this plugin.  You may also not have Silverlight 2 installed on your machine:<br /> <a href="http://go2.microsoft.com/fwlink/?LinkID=124807" style="text-decoration: none;"><img src="http://go2.microsoft.com/fwlink/?LinkId=108181" alt="Get Microsoft Silverlight" style="border-style: none" /></a> </object> <p>Hope this helps.</p>
